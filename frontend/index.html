<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>UAV Logger Chatbot</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                margin: 16px;
                background: #f5f7fb;
            }
            h1 {
                margin-bottom: 8px;
            }
            .card {
                background: #fff;
                padding: 16px;
                border-radius: 8px;
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06);
                margin-bottom: 16px;
            }
            .row {
                display: -ms-flexbox;
                display: flex;
                -ms-flex-wrap: wrap;
                flex-wrap: wrap;
                gap: 12px;
            }
            .col {
                -ms-flex: 1 1 320px;
                flex: 1 1 320px;
                min-width: 0; /* allow flex item to shrink below content width, prevent overflow */
            }
            .progress {
                width: 100%;
                background: #e5e8ed;
                border-radius: 6px;
                overflow: hidden;
                height: 10px;
                margin-top: 6px;
            }
            .progress-bar {
                height: 100%;
                background: #4a90e2;
                width: 0%;
                transition: width 0.2s ease;
            }
            .chat-box {
                max-height: 420px;
                overflow-y: auto;
                padding: 8px;
                border: 1px solid #e5e8ed;
                border-radius: 8px;
                background: #fff;
            }
            .bubble {
                padding: 10px 12px;
                border-radius: 12px;
                margin: 8px 0;
                max-width: 85%;
                position: relative;
            }
            .user {
                background: #d1e8ff;
                margin-left: auto;
            }
            .assistant {
                background: #f0f0f5;
                margin-right: auto;
            }
            .meta {
                font-size: 12px;
                color: #666;
                margin-top: 6px;
            }
            .tag {
                display: inline-block;
                background: #eef3ff;
                color: #4a5a8a;
                border-radius: 10px;
                padding: 2px 8px;
                margin-right: 6px;
                font-size: 12px;
            }
            button {
                cursor: pointer;
            }
            .file-label {
                cursor: pointer;
                display: inline-block;
                padding: 6px 12px;
                background: #4a90e2;
                color: #fff;
                border-radius: 6px;
                font-size: 14px;
            }
            .file-label input[type="file"] {
                position: absolute;
                width: 0.1px;
                height: 0.1px;
                opacity: 0;
                overflow: hidden;
                z-index: -1;
            }
            .small {
                font-size: 12px;
                color: #555;
            }
            pre {
                background: #f7f9fc;
                padding: 8px;
                border-radius: 6px;
                overflow-x: auto;
            }
        </style>
    </head>
    <body>
        <h1>UAV Logger Chatbot</h1>
        <p class="small">
            Upload a MAVLink .bin or .tlog file, view summary/anomalies, and chat with
            the agent.
        </p>

        <div class="row">
            <div class="col">
                <div class="card">
                    <h3>1. Upload Flight Log (.bin / .tlog)</h3>
                    <label class="file-label">
                        Choose File
                        <input type="file" id="fileInput" accept=".bin,.tlog" />
                    </label>
                    <span id="selectedFile" class="small" style="display:block;margin-top:6px;color:#666;">No file chosen</span>
                    <button id="uploadBtn">Upload</button>
                    <button id="loadSampleBtn" class="small" style="margin-left:8px;">Load sample (.tlog)</button>
                    <div class="progress">
                        <div class="progress-bar" id="progressBar"></div>
                    </div>
                    <p id="uploadStatus" class="small"></p>
                    <p id="conversationInfo" class="small"></p>
                    <button id="copyConv" class="small" style="display:none;">
                        Copy conversation_id
                    </button>
                </div>
                <div class="card">
                    <h3>Telemetry Summary</h3>
                    <div id="summary"></div>
                </div>
                <div class="card">
                    <h3>Anomaly Summary</h3>
                    <div id="anomaly"></div>
                </div>
            </div>

            <div class="col">
                <div class="card">
                    <h3>2. Chat</h3>
                    <div class="chat-box" id="chatBox"></div>
                    <div style="margin-top:8px;">
                        <input
                            type="text"
                            id="question"
                            style="width:70%;"
                            placeholder="Ask about the flight..."
                        />
                        <button id="sendBtn">Send</button>
                    </div>
                    <p id="chatHint" class="small">
                        Questions like: "Are there any anomalies?", "Spot issues
                        in GPS data?"
                    </p>
                </div>
            </div>
        </div>

        <script>
            const uploadBtn = document.getElementById("uploadBtn");
            const fileInput = document.getElementById("fileInput");
            const progressBar = document.getElementById("progressBar");
            const uploadStatus = document.getElementById("uploadStatus");
            const summaryDiv = document.getElementById("summary");
            const anomalyDiv = document.getElementById("anomaly");
            const chatBox = document.getElementById("chatBox");
            const questionInput = document.getElementById("question");
            const sendBtn = document.getElementById("sendBtn");
            const conversationInfo = document.getElementById(
                "conversationInfo"
            );
            const copyConv = document.getElementById("copyConv");
            const selectedFileSpan = document.getElementById("selectedFile");
            const loadSampleBtn = document.getElementById("loadSampleBtn");

            let fileId = null;
            let conversationId = null;

            function setConversationInfo() {
                if (conversationId) {
                    conversationInfo.textContent = `conversation_id: ${conversationId}`;
                    copyConv.style.display = "inline-block";
                } else {
                    conversationInfo.textContent =
                        "conversation_id: (not started)";
                    copyConv.style.display = "none";
                }
            }

            fileInput.addEventListener("change", () => {
                const f = fileInput.files[0];
                selectedFileSpan.textContent = f ? f.name : "No file chosen";
                selectedFileSpan.style.color = f ? "#333" : "#666";
            });

            copyConv.addEventListener("click", () => {
                if (conversationId) {
                    navigator.clipboard.writeText(conversationId);
                    copyConv.textContent = "Copied!";
                    setTimeout(
                        () => (copyConv.textContent = "Copy conversation_id"),
                        1500
                    );
                }
            });

            async function doUpload(file) {
                progressBar.style.width = "0%";
                const formData = new FormData();
                formData.append("file", file);
                return new Promise((resolve, reject) => {
                    const xhr = new XMLHttpRequest();
                    xhr.open("POST", "/api/upload");
                    xhr.upload.onprogress = e => {
                        if (e.lengthComputable) {
                            const percent = Math.round((e.loaded / e.total) * 100);
                            progressBar.style.width = percent + "%";
                        }
                    };
                    xhr.onload = async () => {
                        progressBar.style.width = "100%";
                        if (xhr.status === 200) {
                            let res;
                            try {
                                res = JSON.parse(xhr.responseText);
                            } catch (_) {
                                uploadStatus.textContent = "Invalid server response.";
                                reject();
                                return;
                            }
                            if (!res.file_id) {
                                uploadStatus.textContent = res.message || "Upload failed.";
                                reject();
                                return;
                            }
                            fileId = res.file_id;
                            conversationId = null;
                            setConversationInfo();
                            uploadStatus.textContent = `${res.message}`;
                            if (res.parsed_messages !== undefined) {
                                uploadStatus.textContent += ` (parsed_messages: ${res.parsed_messages})`;
                            }
                            await loadSummary();
                            addSystemBubble(`File uploaded. File ID: ${fileId}`);
                            fileInput.value = "";
                            selectedFileSpan.textContent = "No file chosen";
                            selectedFileSpan.style.color = "#666";
                            resolve();
                        } else {
                            let errMsg = `Upload failed: ${xhr.statusText}`;
                            try {
                                const errRes = JSON.parse(xhr.responseText);
                                if (errRes.detail) errMsg = errRes.detail;
                            } catch (_) {}
                            uploadStatus.textContent = errMsg;
                            reject();
                        }
                    };
                    xhr.onerror = () => {
                        uploadStatus.textContent = "Upload failed.";
                        reject();
                    };
                    xhr.send(formData);
                });
            }

            uploadBtn.addEventListener("click", async () => {
                const file = fileInput.files[0];
                if (!file) {
                    alert("Please select a .bin or .tlog file first.");
                    return;
                }
                if (!file.name.toLowerCase().endsWith(".bin") && !file.name.toLowerCase().endsWith(".tlog")) {
                    alert("Only .bin or .tlog files are supported. Selected: " + file.name);
                    return;
                }
                await doUpload(file);
            });

            loadSampleBtn.addEventListener("click", async () => {
                loadSampleBtn.disabled = true;
                uploadStatus.textContent = "Loading sample file...";
                try {
                    const res = await fetch("/api/sample-file");
                    if (!res.ok) {
                        uploadStatus.textContent = "Sample file not found.";
                        return;
                    }
                    const blob = await res.blob();
                    const file = new File([blob], "sample_flight.tlog", { type: "application/octet-stream" });
                    await doUpload(file);
                } catch (e) {
                    uploadStatus.textContent = "Failed to load sample: " + (e.message || "Unknown error");
                } finally {
                    loadSampleBtn.disabled = false;
                }
            });

            async function loadSummary() {
                if (!fileId) {
                    summaryDiv.innerHTML =
                        "<p class='small'>Upload a file to view summary.</p>";
                    anomalyDiv.innerHTML = "";
                    return;
                }
                const res = await fetch(`/api/telemetry/summary/${fileId}`);
                if (!res.ok) {
                    summaryDiv.innerHTML =
                        "<p class='small'>Summary unavailable.</p>";
                    anomalyDiv.innerHTML = "";
                    return;
                }
                const data = await res.json();
                const s = data.summary || {};
                summaryDiv.innerHTML = `
        <p class="small"><strong>Filename:</strong> ${s.filename || "-"} </p>
        <p class="small"><strong>Total messages:</strong> ${s.total_messages ||
            0} </p>
        <p class="small"><strong>Message types:</strong> ${(
            s.message_types || []
        ).join(", ")}</p>
        <p class="small"><strong>Time range:</strong> ${
            s.time_range
                ? `${s.time_range.start} - ${s.time_range.end} (dur ${s.time_range.duration})`
                : "n/a"
        }</p>
      `;
                const a = data.anomaly_summary || {};
                const examples = (a.examples || [])
                    .map(
                        ex =>
                            `<li>${ex.detail || ex.type} @ ${ex.timestamp}</li>`
                    )
                    .join("");
                anomalyDiv.innerHTML = `
        <p class="small"><strong>Status:</strong> ${a.status || "-"} </p>
        <p class="small"><strong>Counts:</strong> ${JSON.stringify(
            a.counts || {}
        )}</p>
        <p class="small"><strong>Battery temp max:</strong> ${a.battery_temp_max ??
            "-"} </p>
        <p class="small"><strong>Altitude range:</strong> ${JSON.stringify(
            a.altitude_range || {}
        )}</p>
        <p class="small"><strong>Notes:</strong> ${(a.notes || []).join(
            " | "
        )}</p>
        <p class="small"><strong>Examples:</strong></p>
        <ul class="small">${examples || "<li>None</li>"}</ul>
      `;
            }

            function addBubble(role, text, sources = [], clarification = null) {
                const div = document.createElement("div");
                div.className = `bubble ${
                    role === "user" ? "user" : "assistant"
                }`;
                div.textContent = text;
                chatBox.appendChild(div);
                if (sources && sources.length) {
                    const meta = document.createElement("div");
                    meta.className = "meta";
                    meta.innerHTML = sources
                        .map(s => `<span class="tag">${s}</span>`)
                        .join("");
                    chatBox.appendChild(meta);
                }
                if (clarification) {
                    const meta = document.createElement("div");
                    meta.className = "meta";
                    meta.textContent = `Clarification: ${clarification}`;
                    chatBox.appendChild(meta);
                }
                chatBox.scrollTop = chatBox.scrollHeight;
            }

            function addSystemBubble(text) {
                const div = document.createElement("div");
                div.className = "bubble assistant";
                div.style.background = "#fff8e1";
                div.textContent = text;
                chatBox.appendChild(div);
                chatBox.scrollTop = chatBox.scrollHeight;
            }

            sendBtn.addEventListener("click", async () => {
                const question = questionInput.value.trim();
                if (!question) return;
                if (!fileId) {
                    addSystemBubble("Please upload a .bin or .tlog file first.");
                    return;
                }
                addBubble("user", question);
                questionInput.value = "";
                const payload = { question, file_id: fileId };
                if (conversationId) payload.conversation_id = conversationId;
                const res = await fetch("/api/chat", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });
                if (!res.ok) {
                    addSystemBubble("Chat request failed.");
                    return;
                }
                const data = await res.json();
                conversationId = data.conversation_id;
                setConversationInfo();
                addBubble(
                    "assistant",
                    data.answer || "(no answer)",
                    data.sources || [],
                    data.clarification_question
                );
                await loadSummary();
            });

            setConversationInfo();
        </script>
    </body>
</html>
